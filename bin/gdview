#! /usr/bin/ruby

$:.unshift(File::join(File::dirname(__FILE__), '..', 'lib'))
require 'gdv'
require 'optparse'

verbose = false
brief = false
convert = false

options = OptionParser.new do |opts|
    opts.on('-v', '--verbose', 'verbose operation') do |dummy|
        verbose = true
    end
    opts.on('-b', '--brief', 'brief output') { |_| brief = true }
    opts.on('-c', '--convert', 'convert field values') { |_| convert = true }
end

options.banner = "gdview [options] file"
options.parse!
unless ARGV.size == 1
    $stderr.puts "error: you need to specify a GDV input file"
    $stderr.puts options
    exit 1
end

begin
    GDV::Format::init
rescue GDV::Format::FormatError => e
    puts "Inconsistent parse tables"
    if verbose
        puts "Index tree is"
        puts GDV::Format::recindex.print
        puts
    end
    puts e.message
    exit 1
end
File::open("/tmp/tree.txt", "w") { |f| f.puts GDV::Format::recindex::print }

r = GDV::Format::Reader.new(ARGV[0])
unknown = 0
loop do
    begin
        rec = r.getrec
        break if rec.nil?
        if rec.known?
            puts "#{rec.satz}.#{rec.sparte}"
            unless brief
                rec.lines.each do |l|
                    l.part.fields.each do |f|
                        v = convert ? f.convert(l.raw) : f.extract(l.raw)
                        unless v =~ /^ *$/
                            s = convert ? "" : " [#{v.size}]"
                            puts "#{f.label}: #{v}#{s}"
                        end
                    end
                    if l == rec.lines.last
                        puts "=" * 70
                    else
                        puts "-" * 70
                    end
                end
            end
        else
            mp = GDV::Format::recindex::match_path(r.line)
            mp.pop
            print "\n***:#{r.lineno}:unknown record:"
            puts mp.collect { |field|
                "#{field.name}@#{field.pos}=#{field.extract(r.line)}"
            }.join(' ')
            unknown += 1
        end
    end
end
puts "#{r.lineno} Saetze, #{unknown} unerkannt"
