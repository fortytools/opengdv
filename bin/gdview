#! /usr/bin/ruby

$:.unshift(File::join(File::dirname(__FILE__), '..', 'lib'))
require 'gdv'

GDV::Format::init
File::open("/tmp/tree.txt", "w") { |f| f.puts GDV::Format::recindex::print }

r = GDV::Format::Reader.new(ARGV[0])
unknown = 0
loop do
    begin
        rec = r.getrec
        break if rec.nil?
        if rec.known?
            puts "\n#{rec.part}"
            rec.part.fields.each do |f|
                v = f.extract(rec.raw)
                unless v =~ /^ *$/
                    puts "#{f.label}: #{f.extract(rec.raw)}"
                end
            end
        else
            mp = GDV::Format::recindex::match_path(r.line)
            mp.pop
            print "\n***:#{r.lineno}:unknown record:"
            puts mp.collect { |field|
                "#{field.name}@#{field.pos}=#{field.extract(r.line)}"
            }.join(' ')
            unknown += 1
        end
    end
end
puts "#{r.lineno} Saetze, #{unknown} unerkannt"
